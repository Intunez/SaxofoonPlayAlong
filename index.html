document.addEventListener('DOMContentLoaded', () => {
    const startButton = document.getElementById('start-button');
    const tempoInput = document.getElementById('tempo');
    const gameArea = document.getElementById('game-area');
    const targetLine = document.getElementById('target-line');
    const scoreDisplay = document.getElementById('score-display');

    // ** LAGE NOTEN REEKS **
    // De noten die de leerling moet spelen. Dit dwingt tot diep blazen.
    // 'duration' is in maten (bij MM=60 is 1 maat 4 seconden).
    const noteSequence = [
        { note: 'Lage D', duration: 2 },  // Blijf 2 maten blazen
        { note: 'Lage C', duration: 1 },  // Blijf 1 maat blazen
        { note: 'Lage Bes', duration: 4 },// Blijf 4 maten blazen (Lang doorblazen!)
        { note: 'Lage D', duration: 1 },
        { note: 'Lage C', duration: 2 },
        { note: 'Lage Bes', duration: 2 },
    ];
    
    let isPlaying = false;
    let audioContext;
    let beatTimer;
    let currentBarIndex = 0;
    const notesPerBar = 4; // Kwartnoten

    // --- AUDIO LOGICA (Simpele metronoom) ---
    function setupAudioContext() {
        if (!audioContext) {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
        }
    }

    function playBeat(time) {
        if (!isPlaying) return;

        // Maak een Oscillator (pieptoon)
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();

        // Hogere toon voor de eerste tel, lagere voor de rest
        const beatCount = currentBarIndex % notesPerBar;
        oscillator.frequency.setValueAtTime(beatCount === 0 ? 880 : 440, time); 
        
        // Zacht volume
        gainNode.gain.setValueAtTime(0.5, time);
        gainNode.gain.exponentialRampToValueAtTime(0.001, time + 0.05); // Snelle fade-out

        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        oscillator.start(time);
        oscillator.stop(time + 0.1);
    }

    function scheduler() {
        const tempo = parseInt(tempoInput.value);
        const beatDuration = 60 / tempo; // Duur van een kwartnoot in seconden

        // We plannen de volgende beat
        if (audioContext.currentTime + 0.1 < beatTimer) {
             // De tijd is nog niet rijp voor de volgende noot
             return;
        }

        // Speel de beat en plan de volgende
        playBeat(beatTimer);
        currentBarIndex++;
        beatTimer += beatDuration;

        // Visuele balken plannen: De balk komt elke 4 tellen (één maat)
        if (currentBarIndex % notesPerBar === 0) {
            scheduleVisualBar(audioContext.currentTime);
        }

        // Blijf herplannen
        if (isPlaying) {
            setTimeout(scheduler, 50); 
        }
    }

    // --- VISUELE LOGICA (De Duikbalken) ---

    function scheduleVisualBar(startTime) {
        if (noteSequence.length === 0) {
            stopGame();
            return;
        }

        const barData = noteSequence.shift();
        const tempo = parseInt(tempoInput.value);
        const barDuration = (60 / tempo) * notesPerBar * barData.duration; // Totale seconden die de noot moet duren
        
        const barElement = document.createElement('div');
        barElement.classList.add('note-bar');
        
        // Label om te weten welke noot te spelen
        barElement.innerHTML = `<span class="note-label">${barData.note}</span>`;

        gameArea.appendChild(barElement);
        
        // Afmetingen en timing:
        // De balk begint helemaal rechts (left: 100%) en moet de speellijn (50%) bereiken
        // De travelDuration is de tijd die nodig is om de helft van het scherm af te leggen
        const travelDuration = 2; // Tijd in seconden van 100% naar 50%
        const totalDurationOnScreen = travelDuration + barDuration;

        // Start animatie
        requestAnimationFrame(() => {
            barElement.style.transition = `transform ${travelDuration}s linear, width ${barDuration}s linear`;
            barElement.style.transform = `translateX(-50%)`;
            barElement.style.width = `50%`; // De balk bereikt de speellijn en heeft de breedte 50%
        });

        // Tijd om de noot aan te houden:
        setTimeout(() => {
            // De leerling moet de noot op dit moment loslaten
            barElement.style.width = '0%'; 
        }, travelDuration * 1000);

        // Verwijder de balk nadat deze volledig is verdwenen
        setTimeout(() => {
            gameArea.removeChild(barElement);
        }, totalDurationOnScreen * 1000);
    }

    // --- START/STOP FUNCTIES ---

    function startGame() {
        if (isPlaying) return;

        setupAudioContext();
        isPlaying = true;
        
        // Reset en start de sequence
        gameArea.innerHTML = '';
        gameArea.appendChild(targetLine);
        currentBarIndex = 0;
        matchesFound = 0;
        
        // Reset de notenreeks voor een nieuw spel (gebruik een kopie)
        const initialSequence = [
            { note: 'Lage D', duration: 2 },
            { note: 'Lage C', duration: 1 },
            { note: 'Lage Bes', duration: 4 }, 
            { note: 'Lage D', duration: 1 },
            { note: 'Lage C', duration: 2 },
            { note: 'Lage Bes', duration: 2 },
        ];
        noteSequence.push(...initialSequence); 

        // Start de timer net iets in de toekomst
        beatTimer = audioContext.currentTime + 0.1; 
        
        startButton.textContent = "Stop Duik";
        scheduler();
    }

    function stopGame() {
        isPlaying = false;
        startButton.textContent = "Start Duik";
        scoreDisplay.textContent = "Spel beëindigd. Probeer opnieuw!";
    }

    startButton.addEventListener('click', () => {
        if (isPlaying) {
            stopGame();
        } else {
            startGame();
        }
    });

    // Zorg ervoor dat het tempo een nummer is
    tempoInput.addEventListener('change', () => {
        if (parseInt(tempoInput.value) < 40) tempoInput.value = 40;
        if (parseInt(tempoInput.value) > 120) tempoInput.value = 120;
    });
});
